<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>工程逆算スケジューラ</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#2563eb">
  <style>
    :root { --print-cell-width: 36px; --print-cell-height: 28px; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 0; background: #f3f6fc; color: #0f172a; }
    .container { max-width: 1280px; margin: 0 auto; padding: 16px; }
    .card { background: #fff; border-radius: 12px; padding: 14px; margin-bottom: 12px; box-shadow: 0 1px 4px rgba(0,0,0,.08); }
    h1 { margin: 4px 0; font-size: 1.35rem; }
    h2 { margin: 4px 0 10px; font-size: 1.05rem; }
    .lead { margin: 0 0 12px; color: #334155; }
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 10px; }
    label { display: block; margin-bottom: 4px; font-size: .9rem; font-weight: 600; }
    input, textarea, button, select {
      width: 100%; box-sizing: border-box; border: 1px solid #cbd5e1; border-radius: 8px; padding: 8px 10px; font-size: 14px;
    }
    textarea { min-height: 72px; resize: vertical; }
    table { width: 100%; border-collapse: collapse; }
    th, td { border: 1px solid #dbe2ef; padding: 6px; font-size: .88rem; }
    th { background: #eff6ff; }
    .matrix { table-layout: fixed; width: max-content; }
    .matrix th, .matrix td { min-width: 40px; text-align: center; padding: 4px; }
    .left-col { min-width: 160px; text-align: left !important; }
    .due-col { min-width: 110px; background: #fef9c3; }
    .primary { background: #2563eb; color: #fff; border-color: #1d4ed8; cursor: pointer; }
    .secondary { background: #e2e8f0; cursor: pointer; }
    .danger { background: #fee2e2; cursor: pointer; }
    .row { display: flex; gap: 8px; align-items: end; }
    .row > * { flex: 1; }
    .inline { display: flex; gap: 6px; align-items: center; }
    .inline input { width: auto; }
    .status { margin-top: 8px; min-height: 1.2em; font-weight: 600; color: #0f766e; }
    .scroll { overflow-x: auto; }
    .legend { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 8px; }
    .chip { padding: 3px 8px; border-radius: 999px; font-size: .78rem; border: 1px solid #cbd5e1; }
    .color-cell { display: flex; align-items: center; gap: 6px; }
    .color-preview { width: 18px; height: 18px; border-radius: 999px; border: 1px solid #94a3b8; flex: 0 0 18px; }
    .step-color { min-width: 52px; padding: 2px; height: 34px; }

    @page { size: A4 landscape; margin: 10mm; }
    @media print {
      body { background: #fff; }
      h1, .lead, .card:not(.print-target) { display: none !important; }
      .container { max-width: none; padding: 0; }
      .print-target { display: block !important; margin: 0; padding: 0; box-shadow: none; border-radius: 0; }
      #result { overflow: visible; }
      .matrix { width: auto; }
      .matrix th, .matrix td { width: var(--print-cell-width); min-width: var(--print-cell-width); height: var(--print-cell-height); padding: 2px; font-size: 10px; }
      .matrix td { line-height: 1.2; vertical-align: middle; overflow: hidden; }
      .matrix td, .matrix th { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
      html[data-print-color='mono'] .matrix td { background: #fff !important; color: #111 !important; }
      .left-col { min-width: 34mm; }
      .due-col { min-width: 24mm; }
    }

    @media (max-width: 768px) {
      .container { padding: 10px; }
      .card { padding: 10px; border-radius: 10px; }
      h1 { font-size: 1.15rem; }
      h2 { font-size: 1rem; }
      .lead { font-size: .88rem; }
      .row { flex-direction: column; align-items: stretch; }
      .row > * { width: 100%; }
      .grid { grid-template-columns: 1fr; }
      .inline { font-size: .9rem; }
      input, textarea, button, select { font-size: 16px; }
      .scroll { overflow-x: auto; -webkit-overflow-scrolling: touch; }
      #stepsTable, #ordersTable { min-width: 640px; }
      .matrix th, .matrix td { min-width: 52px; font-size: .78rem; padding: 4px 3px; }
      .left-col { min-width: 120px; }
      .due-col { min-width: 92px; }
      #deleteLocal { max-width: 220px; }
    }
  </style>
</head>
<body>
<div class="container">
  <h1>工程逆算スケジューラ</h1>
  <p class="lead">複数注文をまとめて表示。納期と作業手順（色付き）を登録し、日付スケールで残作業を見える化します。</p>

  <section class="card">
    <h2>1) 日付スケール設定</h2>
    <div class="grid">
      <div>
        <label for="startDate">表示開始日</label>
        <input type="date" id="startDate">
      </div>
      <div>
        <label for="horizonDays">横に表示する営業日数</label>
        <input type="number" id="horizonDays" min="5" max="90" value="25">
      </div>
      <label class="inline"><input type="checkbox" id="skipWeekend" checked> 土日を除外</label>
    </div>
    <label for="holidayList">追加休日（改行区切り / 例: 2026-02-11）</label>
    <textarea id="holidayList"></textarea>
  </section>

  <section class="card">
    <h2>2) 作業手順登録（工程色つき）</h2>
    <div class="row">
      <div>
        <label for="patternName">パターン名</label>
        <input id="patternName" placeholder="標準">
      </div>
      <div><button id="savePattern" class="secondary">保存</button></div>
      <div>
        <label for="loadPattern">保存済み</label>
        <select id="loadPattern"></select>
      </div>
      <div><button id="deletePattern" class="danger">削除</button></div>
    </div>
    <div class="scroll"><table id="stepsTable" style="margin-top:10px;">
      <thead><tr><th style="width:55px;">順</th><th>工程名</th><th style="width:120px;">日数</th><th style="width:100px;">色</th><th style="width:80px;">削除</th></tr></thead>
      <tbody></tbody>
    </table></div>
    <div class="row" style="margin-top:8px;">
      <button id="addStep" class="secondary">工程追加</button>
      <button id="applySample" class="secondary">サンプル復元</button>
    </div>
    <div class="legend" id="legend"></div>
  </section>

  <section class="card">
    <h2>3) 注文登録（複数件）</h2>
    <div class="scroll"><table id="ordersTable">
      <thead><tr><th style="width:55px;">No</th><th>品名</th><th style="width:150px;">出荷日</th><th style="width:180px;">作業パターン</th><th style="width:80px;">削除</th></tr></thead>
      <tbody></tbody>
    </table></div>
    <div class="row" style="margin-top:8px;">
      <button id="addOrder" class="secondary">注文行追加</button>
      <button id="clearOrders" class="danger">注文をクリア</button>
    </div>
  </section>

  <section class="card">
    <div class="row">
      <button id="generate" class="primary">一覧を生成</button>
      <button id="saveLocal" class="secondary">ローカルに保存</button>
      <button id="loadLocal" class="secondary">呼び出す</button>
    </div>
    <div class="row" style="margin-top:8px;">
      <input id="localSaveName" placeholder="保存名（例: 2026-02-15時点）">
      <select id="localDataSelect"></select>
      <button id="deleteLocal" class="danger">保存データ削除</button>
    </div>
    <div class="row" style="margin-top:8px;">
      <div>
        <label for="printCellWidth">印刷セル横幅（24〜72px）</label>
        <input type="range" id="printCellWidth" min="24" max="72" value="36">
      </div>
      <div>
        <label for="printCellHeight">印刷セル縦幅（20〜64px）</label>
        <input type="range" id="printCellHeight" min="20" max="64" value="28">
      </div>
      <div>
        <label for="printColorMode">印刷カラー</label>
        <select id="printColorMode">
          <option value="color" selected>カラー</option>
          <option value="mono">白黒</option>
        </select>
      </div>
      <button id="printPdf" class="secondary">印刷 / PDF出力</button>
    </div>
    <div class="status" id="status"></div>
  </section>

  <section class="card print-target">
    <h2>4) 出力（Excel風一覧）</h2>
    <div id="result" class="scroll">まだ生成していません。</div>
  </section>
</div>

<script>
(() => {
  const KEY = 'scheduler-patterns-v2';
  const STATE_KEY = 'scheduler-state-v1';
  const BACKUP_KEY = 'scheduler-backups-v1';
  const stepsTbody = document.querySelector('#stepsTable tbody');
  const ordersTbody = document.querySelector('#ordersTable tbody');
  const resultEl = document.getElementById('result');
  const statusEl = document.getElementById('status');

  const SAMPLE_STEPS = [
    { name: '出荷', days: 1, color: '#f59e0b' },
    { name: '検査', days: 1, color: '#8b5cf6' },
    { name: '組立', days: 2, color: '#22c55e' },
    { name: '部材準備', days: 2, color: '#38bdf8' }
  ];

  function showStatus(text, isErr) {
    statusEl.style.color = isErr ? '#b91c1c' : '#0f766e';
    statusEl.textContent = text;
  }

  function applyPrintSettings() {
    const cellWidthValue = Number(document.getElementById('printCellWidth').value) || 36;
    const cellWidth = Math.max(24, Math.min(72, cellWidthValue));
    document.documentElement.style.setProperty('--print-cell-width', cellWidth + 'px');

    const cellHeightValue = Number(document.getElementById('printCellHeight').value) || 28;
    const cellHeight = Math.max(20, Math.min(64, cellHeightValue));
    document.documentElement.style.setProperty('--print-cell-height', cellHeight + 'px');

    const colorMode = document.getElementById('printColorMode').value === 'mono' ? 'mono' : 'color';
    document.documentElement.setAttribute('data-print-color', colorMode);
  }

  function toISO(date) {
    const y = date.getFullYear();
    const m = String(date.getMonth() + 1).padStart(2, '0');
    const d = String(date.getDate()).padStart(2, '0');
    return y + '-' + m + '-' + d;
  }

  function parseHolidaySet() {
    const raw = document.getElementById('holidayList').value;
    const set = new Set();
    raw.split(/\n+/).map(v => v.trim()).filter(Boolean).forEach(v => set.add(v));
    return set;
  }

  function isWorkingDay(date, skipWeekend, holidaySet) {
    if (skipWeekend && (date.getDay() === 0 || date.getDay() === 6)) return false;
    return !holidaySet.has(toISO(date));
  }

  function previousWorkingDay(date, skipWeekend, holidaySet) {
    const out = new Date(date);
    out.setDate(out.getDate() - 1);
    while (!isWorkingDay(out, skipWeekend, holidaySet)) out.setDate(out.getDate() - 1);
    return out;
  }

  function nextWorkingDay(date, skipWeekend, holidaySet) {
    const out = new Date(date);
    out.setDate(out.getDate() + 1);
    while (!isWorkingDay(out, skipWeekend, holidaySet)) out.setDate(out.getDate() + 1);
    return out;
  }

  function dateLabel(date) {
    return (date.getMonth() + 1) + '/' + date.getDate();
  }

  function weekdayLabel(date) {
    return ['日', '月', '火', '水', '木', '金', '土'][date.getDay()];
  }

  function refreshIndices(tbody, selector) {
    [].slice.call(tbody.querySelectorAll('tr')).forEach((tr, i) => {
      tr.querySelector(selector).textContent = String(i + 1);
    });
  }

  function paintColorControl(inputEl, previewEl) {
    const color = inputEl.value;
    inputEl.style.background = color;
    inputEl.style.borderColor = color;
    previewEl.style.background = color;
  }

  function addStepRow(step) {
    const tr = document.createElement('tr');
    tr.innerHTML = '<td class="step-index"></td>' +
      '<td><input class="step-name" placeholder="工程名"></td>' +
      '<td><input type="number" class="step-days" min="1" step="1" value="1"></td>' +
      '<td><div class="color-cell"><span class="color-preview"></span><input type="color" class="step-color" value="#60a5fa"></div></td>' +
      '<td><button type="button" class="danger del-step">×</button></td>';
    tr.querySelector('.step-name').value = step && step.name ? step.name : '';
    tr.querySelector('.step-days').value = step && step.days ? step.days : 1;
    const colorInput = tr.querySelector('.step-color');
    const colorPreview = tr.querySelector('.color-preview');
    colorInput.value = step && step.color ? step.color : '#60a5fa';
    tr.querySelector('.del-step').addEventListener('click', () => {
      tr.remove();
      refreshIndices(stepsTbody, '.step-index');
      renderLegend();
      saveAppState();
    });
    paintColorControl(colorInput, colorPreview);
    colorInput.addEventListener('input', () => {
      paintColorControl(colorInput, colorPreview);
      renderLegend();
      saveAppState();
    });
    colorInput.addEventListener('change', () => {
      paintColorControl(colorInput, colorPreview);
      renderLegend();
      saveAppState();
    });
    tr.querySelector('.step-name').addEventListener('input', renderLegend);
    stepsTbody.appendChild(tr);
    refreshIndices(stepsTbody, '.step-index');
  }

  function collectSteps() {
    const rows = [].slice.call(stepsTbody.querySelectorAll('tr')).map(tr => ({
      name: tr.querySelector('.step-name').value.trim(),
      days: Number(tr.querySelector('.step-days').value),
      color: tr.querySelector('.step-color').value
    }));
    if (!rows.length) throw new Error('工程を1つ以上入力してください。');
    rows.forEach((s, i) => {
      if (!s.name) throw new Error((i + 1) + '行目の工程名が空です。');
      if (!Number.isFinite(s.days) || s.days <= 0) throw new Error((i + 1) + '行目の日数が不正です。');
    });
    return rows;
  }

  function renderLegend() {
    const legend = document.getElementById('legend');
    const steps = collectStepsSafe();
    legend.innerHTML = '';
    steps.forEach(s => {
      const span = document.createElement('span');
      span.className = 'chip';
      span.style.background = s.color;
      span.textContent = s.name + ' (' + s.days + '日)';
      legend.appendChild(span);
    });
  }

  function collectStepsSafe() {
    try { return collectSteps(); } catch (e) { return []; }
  }

  function loadPatterns() {
    try { return JSON.parse(localStorage.getItem(KEY) || '{}'); }
    catch (e) { return {}; }
  }

  function savePatterns(map) {
    localStorage.setItem(KEY, JSON.stringify(map));
  }

  function refreshPatternSelect(selected) {
    const sel = document.getElementById('loadPattern');
    sel.innerHTML = '<option value="">--選択--</option>';
    const map = loadPatterns();
    Object.keys(map).sort().forEach(name => {
      const opt = document.createElement('option');
      opt.value = name;
      opt.textContent = name;
      if (selected && selected === name) opt.selected = true;
      sel.appendChild(opt);
    });
    refreshOrderPatternOptions();
  }

  function addOrderRow(order) {
    const tr = document.createElement('tr');
    tr.innerHTML = '<td class="order-index"></td>' +
      '<td><input class="order-product" placeholder="品名"></td>' +
      '<td><input type="date" class="order-due"></td>' +
      '<td><select class="order-pattern"></select></td>' +
      '<td><button type="button" class="danger del-order">×</button></td>';
    tr.querySelector('.order-product').value = order && order.product ? order.product : '';
    tr.querySelector('.order-due').value = order && order.dueDate ? order.dueDate : '';
    tr.querySelector('.del-order').addEventListener('click', () => {
      tr.remove();
      refreshIndices(ordersTbody, '.order-index');
      saveAppState();
    });
    tr.querySelector('.order-product').addEventListener('input', saveAppState);
    tr.querySelector('.order-due').addEventListener('change', saveAppState);
    tr.querySelector('.order-pattern').addEventListener('change', saveAppState);
    ordersTbody.appendChild(tr);
    refreshOrderPatternOptions();
    if (order && order.patternName) tr.querySelector('.order-pattern').value = order.patternName;
    refreshIndices(ordersTbody, '.order-index');
  }

  function refreshOrderPatternOptions() {
    const map = loadPatterns();
    const names = Object.keys(map).sort();
    [].slice.call(ordersTbody.querySelectorAll('.order-pattern')).forEach(sel => {
      const keep = sel.value;
      sel.innerHTML = '';
      names.forEach(name => {
        const opt = document.createElement('option');
        opt.value = name;
        opt.textContent = name;
        sel.appendChild(opt);
      });
      if (keep && names.indexOf(keep) >= 0) sel.value = keep;
      else if (names.length) sel.value = names[0];
    });
  }

  function collectOrders() {
    const rows = [].slice.call(ordersTbody.querySelectorAll('tr')).map(tr => ({
      product: tr.querySelector('.order-product').value.trim(),
      dueDate: tr.querySelector('.order-due').value,
      patternName: tr.querySelector('.order-pattern').value
    }));
    if (!rows.length) throw new Error('注文を1件以上入力してください。');
    rows.forEach((r, i) => {
      if (!r.product) throw new Error((i + 1) + '行目の品名が空です。');
      if (!r.dueDate) throw new Error((i + 1) + '行目の出荷日が未入力です。');
      if (!r.patternName) throw new Error((i + 1) + '行目の作業パターンが未選択です。');
    });
    return rows;
  }

  function collectOrdersForState() {
    return [].slice.call(ordersTbody.querySelectorAll('tr')).map(tr => ({
      product: tr.querySelector('.order-product').value.trim(),
      dueDate: tr.querySelector('.order-due').value,
      patternName: tr.querySelector('.order-pattern').value
    }));
  }

  function getSettingsState() {
    return {
      startDate: document.getElementById('startDate').value,
      horizonDays: document.getElementById('horizonDays').value,
      skipWeekend: document.getElementById('skipWeekend').checked,
      holidayList: document.getElementById('holidayList').value,
      printCellWidth: document.getElementById('printCellWidth').value,
      printCellHeight: document.getElementById('printCellHeight').value,
      printColorMode: document.getElementById('printColorMode').value
    };
  }

  function saveAppState() {
    const state = {
      settings: getSettingsState(),
      orders: collectOrdersForState()
    };
    localStorage.setItem(STATE_KEY, JSON.stringify(state));
  }

  function loadAppState() {
    try {
      return JSON.parse(localStorage.getItem(STATE_KEY) || '{}');
    } catch (e) {
      return {};
    }
  }

  function restoreAppState() {
    const state = loadAppState();
    if (state.settings) {
      if (state.settings.startDate) document.getElementById('startDate').value = state.settings.startDate;
      if (state.settings.horizonDays) document.getElementById('horizonDays').value = state.settings.horizonDays;
      document.getElementById('skipWeekend').checked = state.settings.skipWeekend !== false;
      document.getElementById('holidayList').value = state.settings.holidayList || '';
      if (state.settings.printCellWidth) document.getElementById('printCellWidth').value = state.settings.printCellWidth;
      else if (state.settings.printCellSize) document.getElementById('printCellWidth').value = state.settings.printCellSize;
      if (state.settings.printCellHeight) document.getElementById('printCellHeight').value = state.settings.printCellHeight;
      else if (state.settings.printRowLines) document.getElementById('printCellHeight').value = String(14 + Number(state.settings.printRowLines) * 7);
      if (state.settings.printColorMode) document.getElementById('printColorMode').value = state.settings.printColorMode;
    }
    if (Array.isArray(state.orders) && state.orders.length) {
      ordersTbody.innerHTML = '';
      state.orders.forEach(order => addOrderRow(order));
    }
  }

  function loadBackups() {
    try {
      return JSON.parse(localStorage.getItem(BACKUP_KEY) || '{}');
    } catch (e) {
      return {};
    }
  }

  function saveBackups(backups) {
    localStorage.setItem(BACKUP_KEY, JSON.stringify(backups));
  }

  function refreshBackupSelect(selected) {
    const sel = document.getElementById('localDataSelect');
    const backups = loadBackups();
    sel.innerHTML = '<option value="">保存データを選択</option>';
    Object.keys(backups).sort().forEach(name => {
      const opt = document.createElement('option');
      opt.value = name;
      opt.textContent = name;
      if (selected && selected === name) opt.selected = true;
      sel.appendChild(opt);
    });
  }

  function saveLocalSnapshot() {
    const name = document.getElementById('localSaveName').value.trim() || ('保存_' + new Date().toISOString().slice(0,16).replace('T','_'));
    const backups = loadBackups();
    backups[name] = {
      savedAt: new Date().toISOString(),
      state: {
        settings: getSettingsState(),
        orders: collectOrdersForState()
      },
      patterns: loadPatterns()
    };
    saveBackups(backups);
    refreshBackupSelect(name);
    showStatus('ローカル保存しました: ' + name);
  }

  function loadLocalSnapshot() {
    const name = document.getElementById('localDataSelect').value;
    if (!name) throw new Error('呼び出す保存データを選択してください。');
    const backups = loadBackups();
    const data = backups[name];
    if (!data) throw new Error('保存データが見つかりません。');

    if (data.patterns && typeof data.patterns === 'object') {
      savePatterns(data.patterns);
      refreshPatternSelect('標準');
    }

    if (data.state && data.state.settings) {
      const st = data.state.settings;
      if (st.startDate) document.getElementById('startDate').value = st.startDate;
      if (st.horizonDays) document.getElementById('horizonDays').value = st.horizonDays;
      document.getElementById('skipWeekend').checked = st.skipWeekend !== false;
      document.getElementById('holidayList').value = st.holidayList || '';
    }

    if (data.state && Array.isArray(data.state.orders)) {
      ordersTbody.innerHTML = '';
      data.state.orders.forEach(order => addOrderRow(order));
    }

    saveAppState();
    showStatus('呼び出しました: ' + name);
  }

  function deleteLocalSnapshot() {
    const name = document.getElementById('localDataSelect').value;
    if (!name) throw new Error('削除する保存データを選択してください。');
    const backups = loadBackups();
    delete backups[name];
    saveBackups(backups);
    refreshBackupSelect();
    showStatus('削除しました: ' + name);
  }

  function buildTimelineDays(startDate, count, skipWeekend, holidaySet) {
    const days = [];
    let cur = new Date(startDate);
    while (days.length < count) {
      if (isWorkingDay(cur, skipWeekend, holidaySet)) days.push(new Date(cur));
      cur = nextWorkingDay(cur, false, new Set());
    }
    return days;
  }

  function calcOrderTasks(order, steps, skipWeekend, holidaySet) {
    const due = new Date(order.dueDate);
    if (Number.isNaN(due.getTime())) throw new Error(order.product + ' の出荷日が不正です。');
    let cursor = new Date(due);
    while (!isWorkingDay(cursor, skipWeekend, holidaySet)) cursor = previousWorkingDay(cursor, skipWeekend, holidaySet);

    const tasks = [];
    for (let i = 0; i < steps.length; i++) {
      const step = steps[i];
      let stepEnd = new Date(cursor);
      let start = new Date(cursor);
      for (let d = 1; d < step.days; d++) start = previousWorkingDay(start, skipWeekend, holidaySet);
      tasks.push({ name: step.name, color: step.color, start: new Date(start), end: new Date(stepEnd), days: step.days });
      cursor = previousWorkingDay(start, skipWeekend, holidaySet);
    }
    return tasks;
  }

  function findTaskForDate(tasks, day) {
    const t = day.getTime();
    for (let i = tasks.length - 1; i >= 0; i--) {
      const task = tasks[i];
      if (task.start.getTime() <= t && t <= task.end.getTime()) return task;
    }
    return null;
  }

  function generate() {
    const map = loadPatterns();
    const orders = collectOrders();
    const activePatternName = document.getElementById('loadPattern').value;
    const activeDraftSteps = collectStepsSafe();
    const startText = document.getElementById('startDate').value;
    const horizon = Number(document.getElementById('horizonDays').value);
    const skipWeekend = document.getElementById('skipWeekend').checked;
    const holidaySet = parseHolidaySet();

    if (!startText) throw new Error('表示開始日を入力してください。');
    if (!Number.isFinite(horizon) || horizon < 5) throw new Error('営業日数は5以上を入力してください。');

    const timelineDays = buildTimelineDays(new Date(startText), horizon, skipWeekend, holidaySet);
    const table = document.createElement('table');
    table.className = 'matrix';

    const thead = document.createElement('thead');
    const rDate = document.createElement('tr');
    rDate.innerHTML = '<th class="left-col">日付</th><th class="due-col">出荷日</th>';
    timelineDays.forEach(d => {
      const th = document.createElement('th');
      th.textContent = dateLabel(d);
      rDate.appendChild(th);
    });
    const rWeek = document.createElement('tr');
    rWeek.innerHTML = '<th class="left-col">曜日</th><th class="due-col"></th>';
    timelineDays.forEach(d => {
      const th = document.createElement('th');
      th.textContent = weekdayLabel(d);
      rWeek.appendChild(th);
    });
    thead.appendChild(rDate);
    thead.appendChild(rWeek);
    table.appendChild(thead);

    const tbody = document.createElement('tbody');

    orders.forEach(order => {
      const steps = order.patternName === activePatternName && activeDraftSteps.length
        ? activeDraftSteps
        : map[order.patternName];
      if (!steps) throw new Error('未登録パターンです: ' + order.patternName);
      const tasks = calcOrderTasks(order, steps, skipWeekend, holidaySet);
      const tr = document.createElement('tr');
      const tName = document.createElement('td');
      tName.className = 'left-col';
      tName.textContent = order.product;
      tr.appendChild(tName);
      const tDue = document.createElement('td');
      tDue.className = 'due-col';
      tDue.textContent = order.dueDate;
      tr.appendChild(tDue);

      timelineDays.forEach(day => {
        const td = document.createElement('td');
        const task = findTaskForDate(tasks, day);
        if (task) {
          td.style.background = task.color;
          td.title = task.name + ' (' + task.days + '日)';
          td.textContent = task.name;
        } else {
        }
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    });

    table.appendChild(tbody);
    resultEl.innerHTML = '';
    resultEl.appendChild(table);
    showStatus('生成完了: ' + orders.length + '件 / ' + horizon + '営業日を表示');
  }

  document.getElementById('addStep').addEventListener('click', () => addStepRow());
  document.getElementById('applySample').addEventListener('click', () => {
    stepsTbody.innerHTML = '';
    SAMPLE_STEPS.forEach(addStepRow);
    renderLegend();
    saveAppState();
  });

  document.getElementById('savePattern').addEventListener('click', () => {
    try {
      const name = document.getElementById('patternName').value.trim();
      if (!name) throw new Error('パターン名を入力してください。');
      const map = loadPatterns();
      map[name] = collectSteps();
      savePatterns(map);
      refreshPatternSelect(name);
      showStatus('パターン「' + name + '」を保存しました。');
      saveAppState();
    } catch (e) {
      showStatus(e.message, true);
    }
  });

  document.getElementById('loadPattern').addEventListener('change', e => {
    const name = e.target.value;
    const map = loadPatterns();
    if (!name || !map[name]) return;
    stepsTbody.innerHTML = '';
    map[name].forEach(addStepRow);
    document.getElementById('patternName').value = name;
    renderLegend();
    saveAppState();
  });

  document.getElementById('deletePattern').addEventListener('click', () => {
    const name = document.getElementById('loadPattern').value;
    if (!name) return showStatus('削除するパターンを選択してください。', true);
    const map = loadPatterns();
    delete map[name];
    savePatterns(map);
    refreshPatternSelect('');
    showStatus('パターン「' + name + '」を削除しました。');
    saveAppState();
  });

  document.getElementById('addOrder').addEventListener('click', () => { addOrderRow(); saveAppState(); });
  document.getElementById('clearOrders').addEventListener('click', () => {
    if (!window.confirm('登録済みの注文をすべて削除します。本当にいいですか？')) return;
    ordersTbody.innerHTML = '';
    addOrderRow({ product: '', dueDate: '', patternName: '標準' });
    showStatus('注文をクリアしました。');
    saveAppState();
  });
  document.getElementById('generate').addEventListener('click', () => {
    try { generate(); } catch (e) { showStatus(e.message, true); }
  });
  document.getElementById('saveLocal').addEventListener('click', () => {
    try { saveLocalSnapshot(); } catch (e) { showStatus(e.message, true); }
  });
  document.getElementById('loadLocal').addEventListener('click', () => {
    try { loadLocalSnapshot(); } catch (e) { showStatus(e.message, true); }
  });
  document.getElementById('deleteLocal').addEventListener('click', () => {
    try { deleteLocalSnapshot(); } catch (e) { showStatus(e.message, true); }
  });
  ['startDate', 'horizonDays', 'holidayList'].forEach(id => {
    document.getElementById(id).addEventListener('input', saveAppState);
  });
  document.getElementById('skipWeekend').addEventListener('change', saveAppState);
  document.getElementById('printCellWidth').addEventListener('input', () => { applyPrintSettings(); saveAppState(); });
  document.getElementById('printCellHeight').addEventListener('input', () => { applyPrintSettings(); saveAppState(); });
  document.getElementById('printColorMode').addEventListener('change', () => { applyPrintSettings(); saveAppState(); });
  document.getElementById('printPdf').addEventListener('click', () => {
    applyPrintSettings();
    window.print();
  });

  const today = new Date();
  document.getElementById('startDate').value = toISO(today);

  const defaultMap = loadPatterns();
  if (!defaultMap['標準']) {
    defaultMap['標準'] = SAMPLE_STEPS;
    savePatterns(defaultMap);
  }
  refreshPatternSelect('標準');
  stepsTbody.innerHTML = '';
  loadPatterns()['標準'].forEach(addStepRow);
  renderLegend();
  restoreAppState();
  applyPrintSettings();
  if (!ordersTbody.querySelector('tr')) addOrderRow({ product: '', dueDate: '', patternName: '標準' });
  refreshBackupSelect();
  saveAppState();

  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => navigator.serviceWorker.register('./service-worker.js'));
  }
})();
</script>
</body>
</html>